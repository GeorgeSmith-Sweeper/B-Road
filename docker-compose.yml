# =============================================================================
# B-Road Docker Compose - Development Configuration
# =============================================================================
# Usage: docker compose up -d
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL with PostGIS
  # ---------------------------------------------------------------------------
  db:
    image: postgis/postgis:15-3.4-alpine
    container_name: b-road-db
    restart: unless-stopped
    shm_size: 256m
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-curvature}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: curvature
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-curvature} -d curvature"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ---------------------------------------------------------------------------
  # FastAPI Backend
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
      target: dev
    container_name: b-road-api
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-curvature}:${POSTGRES_PASSWORD}@db:5432/curvature
      MAPBOX_ACCESS_TOKEN: ${MAPBOX_ACCESS_TOKEN:?MAPBOX_ACCESS_TOKEN is required}
      OSRM_URL: http://osrm:5000
      PYTHONUNBUFFERED: 1
    ports:
      - "8000:8000"
    volumes:
      - ./api:/app/api:ro
      - ./curvature:/app/curvature:ro
      - api_cache:/app/.cache
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ---------------------------------------------------------------------------
  # OSRM Routing Engine
  # ---------------------------------------------------------------------------
  # Only starts with: docker compose --profile routing up
  # Set OSRM_REGION in .env (default: california). Use "us" for full US routing.
  # Prepare data first: ./scripts/prepare-osrm.sh [--native] <region>
  osrm:
    image: osrm/osrm-backend:latest
    platform: linux/amd64
    container_name: b-road-osrm
    restart: unless-stopped
    ports:
      - "5001:5000"
    volumes:
      - ./data/osrm:/data:ro
    command: osrm-routed --algorithm mld --mmap /data/${OSRM_REGION:-california}-latest.osrm
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5000/route/v1/driving/-118.2437,34.0522;-118.2537,34.0622"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - routing

  # ---------------------------------------------------------------------------
  # Next.js Frontend
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: .
      dockerfile: docker/frontend/Dockerfile
      target: dev
    container_name: b-road-frontend
    restart: unless-stopped
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      NEXT_PUBLIC_MAPBOX_TOKEN: ${MAPBOX_ACCESS_TOKEN}
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - next_cache:/app/.next
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# -----------------------------------------------------------------------------
# Named Volumes
# -----------------------------------------------------------------------------
volumes:
  postgres_data:
    name: b-road-postgres-data
  api_cache:
    name: b-road-api-cache
  next_cache:
    name: b-road-next-cache
